# Chrome Tab Auto Grouping - 処理フロー

このドキュメントは、Chrome Tab Auto Grouping拡張機能の修正後の処理フローを詳細に説明します。

## 概要

この拡張機能は、Webサイトのドメインに基づいてタブを自動的にグループ化します。主要な改善点として、**グループ存在確認機能**を追加し、「No group with id: XXXX」エラーを防止しています。

## 主要コンポーネント

### 1. イベントハンドラー
- **Tab Created**: 新しいタブが作成された時の処理
- **Tab Updated**: タブのURL変更時の処理  
- **Tab Moved**: タブがウィンドウ間で移動した時の処理

### 2. グループ管理ユーティリティ
- **Group Verification**: グループの存在確認（新機能）
- **Group Finding**: ドメイン別グループの検索
- **Group Creation**: 新規グループの作成
- **Tab Assignment**: タブのグループ割り当て

## 処理フロー

### タブ作成時のフロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Chrome as Chrome Browser
    participant BG as Background Script
    participant TH as Tab Handler
    participant GU as Group Utils
    participant API as Chrome API

    User->>Chrome: 新しいタブを開く
    Chrome->>BG: onCreated イベント発火
    BG->>TH: handleTabCreated(tab)
    
    TH->>TH: canTabBeGrouped(tab)
    alt タブがグループ化不可
        TH->>BG: 処理終了
    end
    
    TH->>GU: extractDomain(tab.url)
    alt 無効なドメイン
        TH->>BG: 処理終了
    end
    
    TH->>GU: getOrCreateGroupForDomain(domain, windowId)
    GU->>GU: findGroupByDomain(domain, windowId)
    GU->>API: chrome.tabGroups.query()
    
    alt 既存グループが見つかった
        API->>GU: グループ情報を返す
        GU->>TH: 既存グループを返す
    else グループが見つからない
        GU->>GU: createGroupForDomain(domain, windowId)
        GU->>API: chrome.tabs.group() (一時的)
        GU->>API: chrome.tabGroups.update() (タイトル・色設定)
        GU->>API: chrome.tabs.ungroup() (一時タブを削除)
        API->>GU: 新規グループを返す
        GU->>TH: 新規グループを返す
    end
    
    TH->>GU: addTabToGroupSafely(tabId, groupId)
    GU->>GU: addTabToGroup(tabId, groupId)
    
    Note over GU: 🔒 グループ存在確認（新機能）
    GU->>API: chrome.tabGroups.get(groupId)
    
    alt グループが存在しない
        API->>GU: エラー: "No group with id: XXXX"
        GU->>TH: false (失敗)
        TH->>BG: エラーログ出力
    else グループが存在する
        API->>GU: グループ情報を返す
        GU->>API: chrome.tabs.group({tabIds, groupId})
        API->>GU: 成功
        GU->>TH: true (成功)
    end
```

### タブ更新時のフロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Chrome as Chrome Browser
    participant BG as Background Script
    participant TH as Tab Handler
    participant GU as Group Utils
    participant API as Chrome API

    User->>Chrome: タブのURLを変更
    Chrome->>BG: onUpdated イベント発火
    BG->>TH: handleTabUpdated(tabId, changeInfo, tab)
    
    alt URL変更がない
        TH->>BG: 処理終了
    end
    
    TH->>API: chrome.tabs.get(tabId)
    API->>TH: 現在のタブ情報
    
    alt タブが手動グループに所属
        TH->>API: chrome.tabGroups.get(currentGroupId)
        TH->>GU: isAutoGeneratedGroup(groupId)
        alt 手動グループ
            TH->>BG: 処理終了（手動グループは変更しない）
        end
    end
    
    TH->>GU: extractDomain(newUrl)
    alt 無効なドメイン
        TH->>BG: 処理終了
    end
    
    TH->>GU: findGroupByDomain(newDomain, windowId)
    alt 対象グループが見つからない
        TH->>GU: createGroupForDomain(newDomain, windowId)
    end
    
    Note over GU: 🔒 グループ存在確認
    TH->>GU: addTabToGroup(tabId, targetGroupId)
    GU->>API: chrome.tabGroups.get(targetGroupId)
    
    alt グループが存在する
        GU->>API: chrome.tabs.group({tabIds, groupId})
        API->>Chrome: タブがグループに移動
    else グループが存在しない
        API->>GU: エラー
        GU->>TH: false
        TH->>BG: 警告ログ出力
    end
```

### タブ移動時のフロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Chrome as Chrome Browser
    participant BG as Background Script
    participant TH as Tab Handler
    participant GU as Group Utils
    participant API as Chrome API

    User->>Chrome: タブを別ウィンドウに移動
    Chrome->>BG: onMoved イベント発火
    BG->>TH: handleTabMoved(tabId, moveInfo)
    
    TH->>API: chrome.tabs.get(tabId)
    API->>TH: タブ情報
    
    TH->>GU: extractDomain(tab.url)
    alt 無効なドメイン
        TH->>BG: 処理終了
    end
    
    TH->>GU: findGroupByDomain(domain, targetWindowId)
    alt 移動先ウィンドウにグループが存在しない
        TH->>GU: createGroupForDomain(domain, targetWindowId)
    end
    
    Note over GU: 🔒 グループ存在確認
    TH->>GU: addTabToGroup(tabId, targetGroupId)
    GU->>API: chrome.tabGroups.get(targetGroupId)
    
    alt グループが存在する
        GU->>API: chrome.tabs.group({tabIds, groupId})
        API->>Chrome: タブが新しいウィンドウのグループに配置
    else グループが存在しない
        API->>GU: エラー
        GU->>TH: false
        TH->>BG: 警告ログ出力
    end
```

## エラーハンドリング

### 修正前の問題
- グループの存在確認を行わずに `chrome.tabs.group()` を実行
- 削除されたグループIDに対してタブ追加を試行
- 結果として「No group with id: XXXX」エラーが発生

### 修正後の改善
1. **事前グループ検証**: `verifyGroupExists()` 関数でグループの存在を確認
2. **安全な処理**: 存在しないグループの場合は処理をスキップ
3. **適切なログ**: エラー状況を明確に記録

### エラーケースの処理

```mermaid
flowchart TD
    A[addTabToGroup 開始] --> B[verifyGroupExists]
    B --> C{グループが存在?}
    C -->|Yes| D[chrome.tabs.group 実行]
    C -->|No| E[エラーログ出力]
    E --> F[false を返却]
    D --> G{API呼び出し成功?}
    G -->|Yes| H[true を返却]
    G -->|No| I[エラーログ出力]
    I --> J[false を返却]
```

## 主要な改善点

### 1. グループ存在確認機能
```typescript
async function verifyGroupExists(groupId: number): Promise<boolean> {
  try {
    await chrome.tabGroups.get(groupId);
    return true;
  } catch (error) {
    console.warn(`Group with id ${groupId} does not exist:`, error);
    return false;
  }
}
```

### 2. 安全なタブ追加
```typescript
export async function addTabToGroup(tabIds: number | number[], groupId: number): Promise<boolean> {
  try {
    // グループの存在を事前に確認
    const groupExists = await verifyGroupExists(groupId);
    if (!groupExists) {
      console.error(`Cannot add tab to group: Group with id ${groupId} does not exist`);
      return false;
    }

    const tabIdArray = Array.isArray(tabIds) ? tabIds : [tabIds];
    
    await chrome.tabs.group({
      tabIds: tabIdArray,
      groupId
    });
    
    return true;
  } catch (error) {
    console.error('Error adding tab to group:', error);
    return false;
  }
}
```

## パフォーマンス考慮事項

1. **最小限のAPI呼び出し**: グループ存在確認は軽量な `chrome.tabGroups.get()` を使用
2. **早期リターン**: 無効な状態での処理を早期に終了
3. **エラー時の適切な処理**: 失敗時に再試行ループを避ける

## 今後の改善検討項目

1. **キャッシュ機能**: グループ情報のキャッシュでAPI呼び出し数を削減
2. **再試行メカニズム**: 一時的なAPI障害時の自動再試行
3. **ユーザー通知**: グループ作成失敗時のユーザー向け通知機能
4. **設定可能なルール**: ドメイン除外やカスタムグループ名の設定機能