# Chrome Tab Auto Grouping - å‡¦ç†ãƒ•ãƒ­ãƒ¼

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Chrome Tab Auto Groupingæ‹¡å¼µæ©Ÿèƒ½ã®ä¿®æ­£å¾Œã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’è©³ç´°ã«èª¬æ˜ã—ã¾ã™ã€‚

## æ¦‚è¦

ã“ã®æ‹¡å¼µæ©Ÿèƒ½ã¯ã€Webã‚µã‚¤ãƒˆã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«åŸºã¥ã„ã¦ã‚¿ãƒ–ã‚’è‡ªå‹•çš„ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¾ã™ã€‚ä¸»è¦ãªæ”¹å–„ç‚¹ã¨ã—ã¦ã€**ã‚°ãƒ«ãƒ¼ãƒ—å­˜åœ¨ç¢ºèªæ©Ÿèƒ½**ã‚’è¿½åŠ ã—ã€ã€ŒNo group with id: XXXXã€ã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢ã—ã¦ã„ã¾ã™ã€‚

## ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### 1. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- **Tab Created**: æ–°ã—ã„ã‚¿ãƒ–ãŒä½œæˆã•ã‚ŒãŸæ™‚ã®å‡¦ç†
- **Tab Updated**: ã‚¿ãƒ–ã®URLå¤‰æ›´æ™‚ã®å‡¦ç†  
- **Tab Moved**: ã‚¿ãƒ–ãŒã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–“ã§ç§»å‹•ã—ãŸæ™‚ã®å‡¦ç†

### 2. ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- **Group Verification**: ã‚°ãƒ«ãƒ¼ãƒ—ã®å­˜åœ¨ç¢ºèªï¼ˆæ–°æ©Ÿèƒ½ï¼‰
- **Group Finding**: ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—ã®æ¤œç´¢
- **Group Creation**: æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
- **Tab Assignment**: ã‚¿ãƒ–ã®ã‚°ãƒ«ãƒ¼ãƒ—å‰²ã‚Šå½“ã¦

## å‡¦ç†ãƒ•ãƒ­ãƒ¼

### ã‚¿ãƒ–ä½œæˆæ™‚ã®ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Chrome as Chrome Browser
    participant BG as Background Script
    participant TH as Tab Handler
    participant GU as Group Utils
    participant API as Chrome API

    User->>Chrome: æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã
    Chrome->>BG: onCreated ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
    BG->>TH: handleTabCreated(tab)
    
    TH->>TH: canTabBeGrouped(tab)
    alt ã‚¿ãƒ–ãŒã‚°ãƒ«ãƒ¼ãƒ—åŒ–ä¸å¯
        TH->>BG: å‡¦ç†çµ‚äº†
    end
    
    TH->>GU: extractDomain(tab.url)
    alt ç„¡åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³
        TH->>BG: å‡¦ç†çµ‚äº†
    end
    
    TH->>GU: getOrCreateGroupForDomain(domain, windowId)
    GU->>GU: findGroupByDomain(domain, windowId)
    GU->>API: chrome.tabGroups.query()
    
    alt æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã£ãŸ
        API->>GU: ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’è¿”ã™
        GU->>TH: æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿”ã™
    else ã‚°ãƒ«ãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„
        GU->>GU: createGroupForDomain(domain, windowId)
        GU->>API: chrome.tabs.group() (ä¸€æ™‚çš„)
        GU->>API: chrome.tabGroups.update() (ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è‰²è¨­å®š)
        GU->>API: chrome.tabs.ungroup() (ä¸€æ™‚ã‚¿ãƒ–ã‚’å‰Šé™¤)
        API->>GU: æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿”ã™
        GU->>TH: æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿”ã™
    end
    
    TH->>GU: addTabToGroupSafely(tabId, groupId)
    GU->>GU: addTabToGroup(tabId, groupId)
    
    Note over GU: ğŸ”’ ã‚°ãƒ«ãƒ¼ãƒ—å­˜åœ¨ç¢ºèªï¼ˆæ–°æ©Ÿèƒ½ï¼‰
    GU->>API: chrome.tabGroups.get(groupId)
    
    alt ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ãªã„
        API->>GU: ã‚¨ãƒ©ãƒ¼: "No group with id: XXXX"
        GU->>TH: false (å¤±æ•—)
        TH->>BG: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›
    else ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã™ã‚‹
        API->>GU: ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’è¿”ã™
        GU->>API: chrome.tabs.group({tabIds, groupId})
        API->>GU: æˆåŠŸ
        GU->>TH: true (æˆåŠŸ)
    end
```

### ã‚¿ãƒ–æ›´æ–°æ™‚ã®ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Chrome as Chrome Browser
    participant BG as Background Script
    participant TH as Tab Handler
    participant GU as Group Utils
    participant API as Chrome API

    User->>Chrome: ã‚¿ãƒ–ã®URLã‚’å¤‰æ›´
    Chrome->>BG: onUpdated ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
    BG->>TH: handleTabUpdated(tabId, changeInfo, tab)
    
    alt URLå¤‰æ›´ãŒãªã„
        TH->>BG: å‡¦ç†çµ‚äº†
    end
    
    TH->>API: chrome.tabs.get(tabId)
    API->>TH: ç¾åœ¨ã®ã‚¿ãƒ–æƒ…å ±
    
    alt ã‚¿ãƒ–ãŒæ‰‹å‹•ã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±
        TH->>API: chrome.tabGroups.get(currentGroupId)
        TH->>GU: isAutoGeneratedGroup(groupId)
        alt æ‰‹å‹•ã‚°ãƒ«ãƒ¼ãƒ—
            TH->>BG: å‡¦ç†çµ‚äº†ï¼ˆæ‰‹å‹•ã‚°ãƒ«ãƒ¼ãƒ—ã¯å¤‰æ›´ã—ãªã„ï¼‰
        end
    end
    
    TH->>GU: extractDomain(newUrl)
    alt ç„¡åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³
        TH->>BG: å‡¦ç†çµ‚äº†
    end
    
    TH->>GU: findGroupByDomain(newDomain, windowId)
    alt å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„
        TH->>GU: createGroupForDomain(newDomain, windowId)
    end
    
    Note over GU: ğŸ”’ ã‚°ãƒ«ãƒ¼ãƒ—å­˜åœ¨ç¢ºèª
    TH->>GU: addTabToGroup(tabId, targetGroupId)
    GU->>API: chrome.tabGroups.get(targetGroupId)
    
    alt ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã™ã‚‹
        GU->>API: chrome.tabs.group({tabIds, groupId})
        API->>Chrome: ã‚¿ãƒ–ãŒã‚°ãƒ«ãƒ¼ãƒ—ã«ç§»å‹•
    else ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ãªã„
        API->>GU: ã‚¨ãƒ©ãƒ¼
        GU->>TH: false
        TH->>BG: è­¦å‘Šãƒ­ã‚°å‡ºåŠ›
    end
```

### ã‚¿ãƒ–ç§»å‹•æ™‚ã®ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Chrome as Chrome Browser
    participant BG as Background Script
    participant TH as Tab Handler
    participant GU as Group Utils
    participant API as Chrome API

    User->>Chrome: ã‚¿ãƒ–ã‚’åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ç§»å‹•
    Chrome->>BG: onMoved ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
    BG->>TH: handleTabMoved(tabId, moveInfo)
    
    TH->>API: chrome.tabs.get(tabId)
    API->>TH: ã‚¿ãƒ–æƒ…å ±
    
    TH->>GU: extractDomain(tab.url)
    alt ç„¡åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³
        TH->>BG: å‡¦ç†çµ‚äº†
    end
    
    TH->>GU: findGroupByDomain(domain, targetWindowId)
    alt ç§»å‹•å…ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ãªã„
        TH->>GU: createGroupForDomain(domain, targetWindowId)
    end
    
    Note over GU: ğŸ”’ ã‚°ãƒ«ãƒ¼ãƒ—å­˜åœ¨ç¢ºèª
    TH->>GU: addTabToGroup(tabId, targetGroupId)
    GU->>API: chrome.tabGroups.get(targetGroupId)
    
    alt ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã™ã‚‹
        GU->>API: chrome.tabs.group({tabIds, groupId})
        API->>Chrome: ã‚¿ãƒ–ãŒæ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«é…ç½®
    else ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ãªã„
        API->>GU: ã‚¨ãƒ©ãƒ¼
        GU->>TH: false
        TH->>BG: è­¦å‘Šãƒ­ã‚°å‡ºåŠ›
    end
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ä¿®æ­£å‰ã®å•é¡Œ
- ã‚°ãƒ«ãƒ¼ãƒ—ã®å­˜åœ¨ç¢ºèªã‚’è¡Œã‚ãšã« `chrome.tabs.group()` ã‚’å®Ÿè¡Œ
- å‰Šé™¤ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—IDã«å¯¾ã—ã¦ã‚¿ãƒ–è¿½åŠ ã‚’è©¦è¡Œ
- çµæœã¨ã—ã¦ã€ŒNo group with id: XXXXã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

### ä¿®æ­£å¾Œã®æ”¹å–„
1. **äº‹å‰ã‚°ãƒ«ãƒ¼ãƒ—æ¤œè¨¼**: `verifyGroupExists()` é–¢æ•°ã§ã‚°ãƒ«ãƒ¼ãƒ—ã®å­˜åœ¨ã‚’ç¢ºèª
2. **å®‰å…¨ãªå‡¦ç†**: å­˜åœ¨ã—ãªã„ã‚°ãƒ«ãƒ¼ãƒ—ã®å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
3. **é©åˆ‡ãªãƒ­ã‚°**: ã‚¨ãƒ©ãƒ¼çŠ¶æ³ã‚’æ˜ç¢ºã«è¨˜éŒ²

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®å‡¦ç†

```mermaid
flowchart TD
    A[addTabToGroup é–‹å§‹] --> B[verifyGroupExists]
    B --> C{ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨?}
    C -->|Yes| D[chrome.tabs.group å®Ÿè¡Œ]
    C -->|No| E[ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›]
    E --> F[false ã‚’è¿”å´]
    D --> G{APIå‘¼ã³å‡ºã—æˆåŠŸ?}
    G -->|Yes| H[true ã‚’è¿”å´]
    G -->|No| I[ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›]
    I --> J[false ã‚’è¿”å´]
```

## ä¸»è¦ãªæ”¹å–„ç‚¹

### 1. ã‚°ãƒ«ãƒ¼ãƒ—å­˜åœ¨ç¢ºèªæ©Ÿèƒ½
```typescript
async function verifyGroupExists(groupId: number): Promise<boolean> {
  try {
    await chrome.tabGroups.get(groupId);
    return true;
  } catch (error) {
    console.warn(`Group with id ${groupId} does not exist:`, error);
    return false;
  }
}
```

### 2. å®‰å…¨ãªã‚¿ãƒ–è¿½åŠ 
```typescript
export async function addTabToGroup(tabIds: number | number[], groupId: number): Promise<boolean> {
  try {
    // ã‚°ãƒ«ãƒ¼ãƒ—ã®å­˜åœ¨ã‚’äº‹å‰ã«ç¢ºèª
    const groupExists = await verifyGroupExists(groupId);
    if (!groupExists) {
      console.error(`Cannot add tab to group: Group with id ${groupId} does not exist`);
      return false;
    }

    const tabIdArray = Array.isArray(tabIds) ? tabIds : [tabIds];
    
    await chrome.tabs.group({
      tabIds: tabIdArray,
      groupId
    });
    
    return true;
  } catch (error) {
    console.error('Error adding tab to group:', error);
    return false;
  }
}
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

1. **æœ€å°é™ã®APIå‘¼ã³å‡ºã—**: ã‚°ãƒ«ãƒ¼ãƒ—å­˜åœ¨ç¢ºèªã¯è»½é‡ãª `chrome.tabGroups.get()` ã‚’ä½¿ç”¨
2. **æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³**: ç„¡åŠ¹ãªçŠ¶æ…‹ã§ã®å‡¦ç†ã‚’æ—©æœŸã«çµ‚äº†
3. **ã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªå‡¦ç†**: å¤±æ•—æ™‚ã«å†è©¦è¡Œãƒ«ãƒ¼ãƒ—ã‚’é¿ã‘ã‚‹

## ä»Šå¾Œã®æ”¹å–„æ¤œè¨é …ç›®

1. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½**: ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§APIå‘¼ã³å‡ºã—æ•°ã‚’å‰Šæ¸›
2. **å†è©¦è¡Œãƒ¡ã‚«ãƒ‹ã‚ºãƒ **: ä¸€æ™‚çš„ãªAPIéšœå®³æ™‚ã®è‡ªå‹•å†è©¦è¡Œ
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥**: ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆå¤±æ•—æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘é€šçŸ¥æ©Ÿèƒ½
4. **è¨­å®šå¯èƒ½ãªãƒ«ãƒ¼ãƒ«**: ãƒ‰ãƒ¡ã‚¤ãƒ³é™¤å¤–ã‚„ã‚«ã‚¹ã‚¿ãƒ ã‚°ãƒ«ãƒ¼ãƒ—åã®è¨­å®šæ©Ÿèƒ½